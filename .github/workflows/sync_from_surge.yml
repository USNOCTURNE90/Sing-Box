name: Sync from Surge

on:
  schedule:
    - cron: '0 0 * * *' # 每天凌晨自动拉取
  workflow_dispatch:     # 支持手动点击运行

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout self (Sing-Box)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }} # 自动引用你在 Secret 里存的 Token

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Pull and Convert
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          python3 -c '
          import os, json, re, subprocess, shutil
          from pathlib import Path
          from datetime import datetime, timedelta

          def get_time(): return (datetime.utcnow() + timedelta(hours=8)).strftime("%Y-%m-%d %H:%M:%S")

          def parse_to_sb(lines):
              rd = {"domain":[], "domain_suffix":[], "domain_keyword":[], "ip_cidr":[], "ip_asn":[], "process_name":[]}
              vp = {"DOMAIN":"domain", "DOMAIN-SUFFIX":"domain_suffix", "DOMAIN-KEYWORD":"domain_keyword", "IP-CIDR":"ip_cidr", "IP-CIDR6":"ip_cidr", "IP-ASN":"ip_asn", "PROCESS-NAME":"process_name"}
              for l in lines:
                  l = l.strip()
                  if not l or l.startswith("#"): continue
                  ps = l.split(",")
                  px = ps[0].upper()
                  if px in vp and len(ps) >= 2: 
                      rd[vp[px]].append(ps[1].strip())
                  elif re.match(r"^\d+\.\d+\.\d+\.\d+(/\d+)?$", l): 
                      rd["ip_cidr"].append(l if "/" in l else f"{l}/32")
                  elif "." in l and not any(c in l for c in [":", "/", " "]): 
                      rd["domain_suffix"].append(l)
              act = {k: v for k, v in rd.items() if v}
              return {"version": 1, "rules": [act]} if act else None

          # 1. 克隆 Surge 仓库到 /tmp
          token = os.environ.get("GITHUB_TOKEN")
          surge_url = f"https://x-access-token:{token}@github.com/USNOCTURNE90/Surge.git"
          temp_dir = Path("/tmp/surge_rules")
          if temp_dir.exists(): shutil.rmtree(temp_dir)
          subprocess.run(["git", "clone", surge_url, str(temp_dir)], check=True)

          # 2. 识别并转换
          # 排除脚本、配置、文档
          excludes = [".git", ".github", "LICENSE", "README.md", "format_rules.py", "full_sync.py"]
          files = [f for f in temp_dir.glob("*") if f.is_file() and f.name not in excludes and f.suffix not in [".py", ".yml", ".md", ".conf"]]
          
          processed = 0
          for f_path in files:
              print(f"转换文件中: {f_path.name}")
              with open(f_path, "r", encoding="utf-8") as f:
                  sb_data = parse_to_sb(f.readlines())
              if sb_data:
                  # 存入 Sing-Box 仓库根目录，统一加 .json 方便识别
                  target = Path(".") / f"{f_path.name}.json"
                  with open(target, "w", encoding="utf-8") as f:
                      json.dump(sb_data, f, indent=2, ensure_ascii=False)
                  processed += 1

          # 3. 推送回 Sing-Box
          if processed > 0:
              subprocess.run(["git", "add", "*.json"], check=True)
              if subprocess.run(["git", "status", "--porcelain"], capture_output=True, text=True).stdout.strip():
                  subprocess.run(["git", "commit", "-m", f"自动拉取同步: {get_time()}"], check=True)
                  subprocess.run(["git", "push"], check=True)
                  print("✅ 转换完成并已推送到 Sing-Box 仓库")
              else:
                  print("ℹ️ 内容无变化")
          '
